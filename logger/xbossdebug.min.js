!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.XbossDebug=t()}(this,function(){var e={typeDecide:function(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"},isFunction:function(t){return e.typeDecide(t,"Function")},isString:function(t){return e.typeDecide(t,"String")},serializeObj:function(t){var n="";return Object.keys(t).forEach(function(r){e.typeDecide(t[r],"Object")?n+=r+"="+JSON.stringify(t[r]):n+=r+"="+t[r]+"^"}),encodeURIComponent(n.substr(0,n.length-1))},noop:function(){},now:function(){return(new Date).getTime()}},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},i=function(){function e(n){t(this,e),this.config={version:"1.0.0",setSystemInfo:!1,setLocation:!1,key:"",mergeReport:!0,delay:1e3,url:"",except:[/^Script error\.?/,/^Javascript error: Script error\.? on line 0/],random:1,repeat:5},this.config=Object.assign(this.config,n)}return n(e,[{key:"get",value:function(e){return this.config[e]}},{key:"set",value:function(e,t){return this.config[e]=t,this.config[e]}}]),e}(),u=function(){function e(){t(this,e),this.handlers={}}return n(e,[{key:"on",value:function(e,t){return this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.handlers[e]}},{key:"off",value:function(e){this.handlers[e]&&delete this.handlers[e]}},{key:"trigger",value:function(e,t){var n=this,r=t||[],o=this.handlers[e];return!o||o.every(function(e){return!1!==e.apply(n,r)})}}]),e}(),c=function(c){function s(e){t(this,s);var n=o(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e));return n.errorQueue=[],n.repeatList={},n.config=(new i).config,["log","debug","info","warn","error"].forEach(function(e,t){n[e]=function(r){return n.handleMsg(r,e,t)}}),n}return r(s,u),n(s,[{key:"setOptions",value:function(e){Object.assign(this.config,e)}},{key:"repeat",value:function(e){var t=e.rowNum||"",n=e.colNum||"",r=e.msg+t+n;return this.repeatList[r]=this.repeatList[r]?this.repeatList[r]+1:1,this.repeatList[r]>this.config.repeat}},{key:"except",value:function(t){var n=this.config.except,r=!1,o=null;if(e.typeDecide(n,"Array"))for(var i=0,u=n.length;i<u;i++)if(o=n[i],e.typeDecide(o,"RegExp")&&o.test(t.msg)){r=!0;break}return r}},{key:"request",value:function(e,t,n){if(!this.config.key)throw new Error("please set key in xbossdebug.config.key");t.key=this.config.key,wx.request({url:e,method:"POST",data:t,success:n})}},{key:"report",value:function(e){var t=this,n=this.config.mergeReport;if(0===this.errorQueue.length)return this.config.url;var r=n?this.errorQueue:[this.errorQueue.shift()];n&&(this.errorQueue=[]);var o=this.config.url,i={error:r,systemInfo:this.systemInfo,breadcrumbs:this.breadcrumbs,locationInfo:this.locationInfo,networkType:this.networkType,notifierVersion:this.config.version};return this.request(o,i,function(){e&&e.call(t),t.trigger("afterReport")}),o}},{key:"send",value:function(t){var n=this;if(this.trigger("beforeReport")){var r=t||e.noop,o=this.config.mergeReport?this.config.delay:0;setTimeout(function(){n.report(r)},o)}}},{key:"catchError",value:function(e){return!(Math.random()>=this.config.random)&&(!this.repeat(e)&&(!this.except(e)&&(this.errorQueue.push(e),this.errorQueue)))}},{key:"handleMsg",value:function(t,n,r){if(!t)return!1;var o=e.typeDecide(t,"Object")?t:{msg:t};return o.level=r,o.type=n,o.time=Date.now(),this.catchError(o)&&this.send(),o}}]),s}();return new(function(i){function u(e){t(this,u);var n=o(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,e));return n.breadcrumbs=[],n.activePage={},n.rewriteApp(),n.rewritePage(),n}return r(u,c),n(u,[{key:"rewriteApp",value:function(){var t=App,n=this;App=function(r){return["onLaunch","onShow","onHide","onError"].forEach(function(t){var o=r[t];"onLaunch"===t&&(n.getNetworkType(),n.config.setLocation&&n.getLocation(),n.config.setSystemInfo&&n.getSystemInfo()),r[t]=function(r){var i={type:"function",time:e.now(),belong:"App",method:t,path:r&&r.path,query:r&&r.query,scene:r&&r.scene};return n.pushToBreadcrumb(i),"onError"===t&&n.error({msg:r}),o&&o.call(this,r)}}),t(r)}}},{key:"rewritePage",value:function(){var e=this,t=Page;Page=function(n){return Object.keys(n).forEach(function(t){"function"==typeof n[t]&&e.recordPageFn(n,t)}),n.onReady||e.recordPageFn(n,"onReady"),n.onLoad||e.recordPageFn(n,"onLoad"),t(n)}}},{key:"getActivePage",value:function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}}},{key:"pushToBreadcrumb",value:function(e){this.breadcrumbs.push(e),this.breadcrumbs.length>20&&this.breadcrumbs.shift()}},{key:"recordPageFn",value:function(t,n){var r=t[n],o=this;t[n]=function(){"onLoad"!==n&&"onShow"!==n||(o.activePage=o.getActivePage());var t={type:"function",time:e.now(),belong:"Page",method:n,route:o.activePage&&o.activePage.route,options:o.activePage&&o.activePage.options};return"onLoad"===n&&(t.args=arguments),o.methodFilter(n)&&o.pushToBreadcrumb(t),r&&r.apply(this,arguments)}}},{key:"methodFilter",value:function(e){return"onPageScroll"!==e}},{key:"getNetworkType",value:function(){var e=this;wx.getNetworkType({success:function(t){e.networkType=t.networkType}})}},{key:"getSystemInfo",value:function(){var e=this;wx.getSystemInfo({success:function(t){e.systemInfo=t}})}},{key:"getLocation",value:function(){var e=this;wx.getLocation({type:"wgs84",success:function(t){e.locationInfo=t}})}}]),u}())});
